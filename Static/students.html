<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Student Search & List</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
    .wrap { max-width: 900px; margin: 36px auto; padding: 24px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-radius: 12px; }
    h1 { margin: 0 0 16px 0; font-size: 24px; color: #0b3b61; }
    .search-row { display: flex; gap: 10px; margin-bottom: 20px; }
    input[type="text"] { flex-grow: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px; }
    button.primary { background: #1f6feb; color: #fff; border: 0; padding: 10px 14px; border-radius: 6px; cursor: pointer; }
    a.secondary { text-decoration: none; padding: 10px 14px; border-radius: 6px; border: 1px solid #d1d5db; color: #333; background: #f9f9f9; }
    
    /* Button Styles for Table Actions */
    .button { text-decoration: none; padding: 6px 10px; border-radius: 4px; font-size: 13px; font-weight: 600; display: inline-block; cursor: pointer; }
    .button.primary { background: #1f6feb; color: #fff; border: none; }
    .button.secondary { background: #e0f2fe; color: #007bff; border: 1px solid #bae6fd; }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; border-bottom: 1px solid #ececec; text-align: left; }
    th { background: #f3f3f9; font-weight: 600; }
    .status-message { margin-top: 15px; padding: 10px; background: #fff3cd; color: #856404; border: 1px solid #ffeeba; border-radius: 4px; display: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Student List and Search</h1>
    <a href="/" class="secondary" style="margin-bottom: 20px; display: inline-block;">&larr; Back to Home</a>

    <div class="search-row">
      <input type="text" id="searchInput" placeholder="Search by First and/or Last Name..." onkeyup="if(event.key === 'Enter') searchStudents()" />
      <button class="primary" onclick="searchStudents()">Search</button>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <table id="studentTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Nickname</th>
          <th>Class/Grade</th>
          <th>Points</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="studentTableBody">
        <tr><td colspan="6" style="text-align: center;">Enter a search term above to find students.</td></tr>
      </tbody>
    </table>

  </div>

<script>
  // Key used to store the last search term in the browser's local storage
  const LAST_SEARCH_KEY = 'lastStudentSearchTerm';

  async function searchStudents() {
    const searchInput = document.getElementById('searchInput');
    const statusMessage = document.getElementById('statusMessage');
    const tableBody = document.getElementById('studentTableBody');
    const query = searchInput.value.trim();

    statusMessage.style.display = 'none';
    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Searching...</td></tr>';
    
    // 1. Save the query for context restoration
    localStorage.setItem(LAST_SEARCH_KEY, query);

    if (query.length < 2) {
      statusMessage.textContent = 'Please enter at least 2 characters to search.';
      statusMessage.style.display = 'block';
      tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Enter a search term above to find students.</td></tr>';
      
      // If the query is invalid, clear the saved term
      localStorage.removeItem(LAST_SEARCH_KEY); 
      return;
    }

    try {
      // Calls the API route defined in app.py
	  const response = await fetch(`/api/students/search?term=${encodeURIComponent(query)}`);
      const data = await response.json();

      const studentData = data.students || []; 

      if (data.success) {
        if (studentData.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No students found matching your search.</td></tr>';
        } else {
          renderTable(studentData);
        }
		statusMessage.textContent = data.message || `Found ${studentData.length} student(s).`;
        statusMessage.style.display = 'block';
        statusMessage.style.backgroundColor = '#d4edda'; // Success-like color
        statusMessage.style.color = '#155724';
      } else {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Error performing search.</td></tr>';
        statusMessage.textContent = data.message || 'An unknown error occurred on the server.';
        statusMessage.style.display = 'block';
        statusMessage.style.backgroundColor = '#f8d7da'; // Error color
        statusMessage.style.color = '#721c24';
      }
    } catch (e) {
      console.error('Fetch error:', e);
      tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Network error. Could not connect to the server.</td></tr>';
      statusMessage.textContent = 'A network error occurred. Check the console for details.';
      statusMessage.style.display = 'block';
    }
  }

  function renderTable(students) {
    const tableBody = document.getElementById('studentTableBody');
    tableBody.innerHTML = students.map(student => `
      <tr>
        <td>${student.id}</td>
        <td>${student.name}</td>
        <td>${student.nickname || '-'}</td>
        <td>${(student.classroom || '-') + (student.grade ? ' (' + student.grade + ')' : '')}</td>
        <td>${student.total_points}</td>
		<td style="white-space: nowrap;">
          <a href="/student/${student.id}" class="button primary" style="margin-right: 5px;" onclick="saveContext()">View/Edit</a>
          <a href="/student_history/${student.id}" class="button secondary" onclick="saveContext()">History</a>
        </td>
      </tr>
    `).join('');
  }

  // Helper function to save context before navigating to a detail page
  function saveContext() {
      const query = document.getElementById('searchInput').value.trim();
      if (query.length >= 2) {
          localStorage.setItem(LAST_SEARCH_KEY, query);
      }
  }

  // Function to run on page load
  function initializePage() {
    const savedQuery = localStorage.getItem(LAST_SEARCH_KEY);
    const searchInput = document.getElementById('searchInput');

    // If a query was saved, populate the input and run the search automatically
    if (savedQuery && savedQuery.length >= 2) {
      searchInput.value = savedQuery;
      searchStudents();
    } else {
      // Clear storage if the last query was invalid or non-existent
      localStorage.removeItem(LAST_SEARCH_KEY);
    }
  }
  
  // Call the initializer when the DOM is ready
  document.addEventListener('DOMContentLoaded', initializePage);
</script>

</body>
</html>