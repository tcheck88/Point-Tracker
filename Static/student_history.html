<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title id="pageTitle">Student Activity History</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
    .wrap { max-width: 900px; margin: 36px auto; padding: 24px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-radius: 12px; }
    h1 { margin: 0 0 16px 0; font-size: 24px; color: #0b3b61; }
    .secondary-link { text-decoration: none; padding: 8px 14px; border-radius: 6px; border: 1px solid #d1d5db; color: #333; background: #f9f9f9; font-weight: 600; display: inline-block; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; border-bottom: 1px solid #ececec; text-align: left; font-size: 14px; }
    th { background: #f3f3f9; font-weight: 600; }
    .status-message { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
    .status-message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .points-cell { font-weight: 700; color: #155724; }
    #downloadCsvBtn { background: #155724; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
        <h1 id="headerTitle">Loading History...</h1>
        <p id="totalPointsDisplay" style="font-size: 18px; font-weight: 700; color: #1f6feb;">Current Points: 0</p>
    </div>
    
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <a href="/students" class="secondary-link">&larr; Back to Students</a>
        <button id="downloadCsvBtn">Download CSV</button>
    </div>
    
    <div id="statusMessage" class="status-message"></div>

    <table id="historyTable">
      <thead>
        <tr>
          <th>Date/Time</th>
          <th>Activity</th>
          <th>Points</th>
          <th>Recorded By</th>
          <th>Trans. ID</th>
        </tr>
      </thead>
      <tbody id="historyTableBody">
        <tr><td colspan="5" style="text-align: center;">Loading data...</td></tr>
      </tbody>
    </table>

  </div>

<script>
    // --- UTILITIES ---

    // Helper function to format the timestamp
    function formatTime(timestamp) {
        if (!timestamp) return 'N/A';
        try {
            // Assumes ISO format from Python (e.g., 2025-12-15T13:53:40Z)
            return new Date(timestamp).toLocaleString();
        } catch {
            return timestamp;
        }
    }

    // Helper function to display status messages
    function showStatus(message, isError = false) {
        const msgDiv = document.getElementById('statusMessage');
        msgDiv.textContent = message;
        msgDiv.className = isError ? 'status-message error' : 'status-message success';
        msgDiv.style.display = 'block';
    }
    
    // --- DOWNLOAD FUNCTION ---
    function downloadCsv(historyData, studentId, studentName) {
        if (historyData.length === 0) {
            showStatus("No data to download.", true);
            return;
        }
        
        // 1. Create CSV header
        const header = ["Transaction ID", "Student ID", "Activity", "Points", "Date/Time", "Recorded By"];
        
        // 2. Map data rows
        const csvRows = historyData.map(record => [
            record.id,
            record.student_id,
            `"${record.activity}"`, // Enclose text in quotes to handle commas
            record.points,
            `"${formatTime(record.date)}"`,
            `"${record.performed_by}"`
        ].join(','));
        
        // 3. Combine header and rows
        const csvContent = [header.join(','), ...csvRows].join('\n');
        
        // 4. Create blob and download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        
        link.setAttribute("href", url);
        link.setAttribute("download", `Activity_History_${studentId}_${studentName.replace(/\s/g, '_')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showStatus("Download initiated.", false);
    }

    // --- FETCH FUNCTION ---
    async function fetchStudentHistory() {
        const pathSegments = window.location.pathname.split('/');
        // The student ID is the last segment of the URL: /student_history/123
        const studentId = pathSegments[pathSegments.length - 1]; 
        const headerTitle = document.getElementById('headerTitle');
        const tableBody = document.getElementById('historyTableBody');
        const pointsDisplay = document.getElementById('totalPointsDisplay');
        const downloadBtn = document.getElementById('downloadCsvBtn');
        
        let historyRecords = [];
        // CRITICAL: Initialize download button event handler with stored data
        downloadBtn.onclick = () => downloadCsv(historyRecords, studentId, headerTitle.textContent.split(': ')[1] || 'Student');

        if (!studentId || isNaN(studentId)) {
            headerTitle.textContent = 'Error';
            showStatus("Invalid Student ID in URL.", true);
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Invalid ID.</td></tr>';
            return;
        }

        headerTitle.textContent = `Activity History for Student ID: ${studentId}`;

        try {
            const response = await fetch(`/api/student/${studentId}/history`);
            const data = await response.json();

            if (data.success) {
                const history = data.history;
                
                // CRITICAL FIX 1: Display current points and student name from API response
                pointsDisplay.textContent = `Current Points: ${data.total_points || 0}`;
                const studentName = data.student_name || 'Unknown Student';
                headerTitle.textContent = `Activity History for ${studentName} (ID: ${studentId})`;
                historyRecords = history; // Store data for CSV download

                if (history.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No activity records found for this student.</td></tr>';
                    showStatus(`Found 0 records for ${studentName}.`, true);
                } else {
                    renderTable(history);
                    showStatus(`Successfully loaded ${history.length} records for ${studentName}.`, false);
                }
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Error loading history.</td></tr>';
                showStatus(data.message || 'Error fetching data from server.', true);
            }

        } catch (e) {
            console.error('Fetch error:', e);
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Network error.</td></tr>';
            showStatus('Network error. Could not connect to the API.', true);
        }
    }

    // Renders the transaction table rows
    function renderTable(history) {
        const tableBody = document.getElementById('historyTableBody');
        tableBody.innerHTML = history.map(record => `
            <tr>
                <td>${formatTime(record.date)}</td>
                <td>${record.activity}</td>
                <td class="points-cell">+${record.points}</td>
                <td>${record.performed_by || 'System'}</td>
                <td>${record.id}</td>
            </tr>
        `).join('');
    }

    fetchStudentHistory();
</script>
</body>
</html>