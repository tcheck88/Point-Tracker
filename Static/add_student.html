<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Add Student — Leer México</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; background:#f3f4f6; margin:0; padding:40px; }
    .modal { width:640px; margin:0 auto; background:#fff; border-radius:6px; box-shadow:0 6px 24px rgba(0,0,0,0.12); padding:20px; }
    h1 { margin:0 0 12px 0; font-size:20px; color:#0b3b61; }
    label { display:block; margin-top:12px; font-weight:600; color:#333; }
    input[type="text"], select, input[type="email"] { width:100%; padding:10px; margin-top:6px; border:1px solid #d1d5db; border-radius:4px; font-size:14px; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    .help { font-size:12px; color:#6b7280; margin-top:6px; }
    .actions { margin-top:18px; display:flex; justify-content:flex-end; gap:10px; }
    button { padding:10px 14px; border-radius:4px; font-weight:600; cursor:pointer; border: none; }
    .btn-secondary { background:#fff; border:1px solid #d1d5db; color:#111; }
    .btn-primary { background:#0b69a3; color:#fff; }
    .toast { margin-top:12px; padding:10px; border-radius:4px; background:#fef3c7; color:#92400e; display:none; }
    .errors { margin-top:12px; color:#b91c1c; }
    .duplicate-panel { margin-top:12px; background:#fff7ed; border:1px solid #ffedd5; padding:10px; border-radius:4px; display:none; }
    .duplicate-item { padding:8px; border-bottom:1px solid #fde8d9; display:flex; justify-content:space-between; align-items:center; }
    .duplicate-item:last-child { border-bottom:none; }
    .consent { display:flex; align-items:center; gap:8px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="modal" role="dialog" aria-labelledby="title">
    <h1 id="title">Add Student</h1>

    <label for="full_name">Full Name <span aria-hidden="true" style="color:#b91c1c">*</span></label>
    <input id="full_name" type="text" autocomplete="name" placeholder="Full name as it appears on certificates" />
	
    <label for="nickname">Nickname</label>
    <input id="nickname" type="text" placeholder="Optional display name" />

    <label for="parent_name">Parent / Guardian name (optional)</label>
    <input id="parent_name" type="text" placeholder="Parent or guardian name" />

    <label for="email">Email (optional)</label>
    <input id="email" type="email" placeholder="name@example.com" />

    <label for="phone">Phone (optional)</label>
    <input id="phone" type="text" placeholder="+52 55 1234 5678" />
    <div class="help">If you consent to SMS, please enter a phone number in Mexico format (10-digit national number, optional +52).</div>

    <div class="consent">
      <input id="sms_consent" type="checkbox" />
      <label for="sms_consent" style="margin:0;font-weight:600">I agree to receive SMS messages</label>
    </div>

    <div class="row">
      <div>
        <label for="classroom">Classroom</label>
        <select id="classroom"><option value="">-- select --</option><option>A1</option><option>B2</option></select>
      </div>
      <div>
        <label for="grade">Grade</label>
        <select id="grade"><option value="">-- select --</option><option>1</option><option>2</option><option>3</option></select>
      </div>
    </div>

    <div id="duplicatePanel" class="duplicate-panel" aria-live="polite"></div>

    <div id="errors" class="errors" role="alert"></div>
    <div id="toast" class="toast" role="status"></div>

    <div class="actions">
		<button id="btnSave" class="btn-primary">Add Student</button>  <button id="btnCancel" class="btn-secondary">Cancel</button>
    </div>
  </div>

<script>
(() => {
  const PHONE_RE = /^(?:\+?52\s?)?(?:\(?\d{2,3}\)?[\s-]?){1}\d{7,8}$/;
  const EMAIL_RE = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;

  const el = {
    fullName: document.getElementById('full_name'),
    nickname: document.getElementById('nickname'),
    parentName: document.getElementById('parent_name'),
    email: document.getElementById('email'),
    phone: document.getElementById('phone'),
    smsConsent: document.getElementById('sms_consent'),
    classroom: document.getElementById('classroom'),
    grade: document.getElementById('grade'),
    btnSave: document.getElementById('btnSave'),
    btnCancel: document.getElementById('btnCancel'),
    errors: document.getElementById('errors'),
    toast: document.getElementById('toast'),
    duplicatePanel: document.getElementById('duplicatePanel')
  };

  function showErrors(list) {
    el.errors.textContent = list.join(' | ');
  }
  function clearErrors() {
    el.errors.textContent = '';
  }
  function showToast(message) {
    el.toast.style.display = 'block';
    el.toast.textContent = message;
    setTimeout(() => el.toast.style.display = 'none', 5000);
  }

  async function checkDuplicates() {
    const name = el.fullName.value.trim();
    const phone = el.phone.value.trim();
    const email = el.email.value.trim();
    el.duplicatePanel.style.display = 'none';
    el.duplicatePanel.innerHTML = '';
    if (!name && !phone && !email) return;

    try {
      const res = await fetch('/api/check_duplicates', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name, phone, email })
      });
      if (res.status === 200) {
        const json = await res.json();
        if (json && json.matches && json.matches.length) {
          el.duplicatePanel.style.display = 'block';
          el.duplicatePanel.innerHTML = '<strong>Possible matches found</strong>';
          json.matches.forEach(m => {
            const div = document.createElement('div');
            div.className = 'duplicate-item';
            div.innerHTML = `<div><strong>${m.name}</strong><div style="font-size:12px;color:#374151">${m.classroom || 'Unassigned'} • ${m.phone || (m.email || 'no contact')}</div></div>
                             <div><button data-id="${m.id}" class="view-btn">View</button></div>`;
            el.duplicatePanel.appendChild(div);
          });
        }
      }
    } catch (e) { console.warn('dup check error', e); }
  }

  el.fullName.addEventListener('blur', checkDuplicates);
  el.phone.addEventListener('blur', checkDuplicates);
  el.email.addEventListener('blur', checkDuplicates);

  el.btnCancel.addEventListener('click', () => {
    window.location.href = '/';
  });

  el.btnSave.addEventListener('click', async () => {
    clearErrors();
    const full_name = el.fullName.value.trim();
    const nickname = el.nickname.value.trim();
    const parent_name = el.parentName.value.trim();
    const email = el.email.value.trim();
    const phone = el.phone.value.trim();
    const sms_consent = el.smsConsent.checked;
    const classroom = el.classroom.value;
    const grade = el.grade.value;

    const clientErrors = [];
    if (!full_name) clientErrors.push('Full name is required.');
    if (email && !EMAIL_RE.test(email)) clientErrors.push('Email looks invalid.');
    if (sms_consent && !phone) clientErrors.push('Phone is required if consenting to SMS.');
    if (phone && !PHONE_RE.test(phone)) clientErrors.push('Phone looks invalid for Mexico.');

    if (clientErrors.length) { showErrors(clientErrors); return; }

    try {
      const resp = await fetch('/api/add_student', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          full_name, nickname, parent_name, email, phone, sms_consent, classroom, grade, created_by: 'web_admin'
        })
      });

      if (resp.status === 201) {
        const ok = await resp.json();
        // FIXED: Use student_id
        showToast('Student created (ID: ' + ok.student_id + ')');
        el.fullName.value = '';
        el.nickname.value = '';
        el.parentName.value = '';
        el.email.value = '';
        el.phone.value = '';
        el.smsConsent.checked = false;
        el.classroom.value = '';
        el.grade.value = '';
        el.duplicatePanel.style.display = 'none';
      } else if (resp.status === 409) {
        const json = await resp.json();
        el.duplicatePanel.style.display = 'block';
        el.duplicatePanel.innerHTML = '<strong>Potential duplicates returned from server</strong>';
        (json.duplicates || []).forEach(m => {
          const div = document.createElement('div');
          div.className = 'duplicate-item';
          div.innerHTML = `<div><strong>${m.name}</strong><div style="font-size:12px;color:#374151">${m.classroom || 'Unassigned'}</div></div>`;
          el.duplicatePanel.appendChild(div);
        });

        // Add Save Anyway button
        const overrideBtn = document.createElement('button');
        overrideBtn.textContent = 'Save Anyway';
        overrideBtn.className = 'btn-primary';
        overrideBtn.style.marginTop = '12px';
        overrideBtn.addEventListener('click', async () => {
          try {
            const resp2 = await fetch('/api/add_student', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({
                full_name, nickname, parent_name, email, phone, sms_consent, classroom, grade,
                created_by: 'web_admin',
                confirmed_not_duplicate: true
              })
            });

            if (resp2.status === 201) {
              const ok = await resp2.json();
              // FIXED: Use student_id
              showToast('Student created (ID: ' + ok.student_id + ')');
              el.fullName.value = '';
              el.nickname.value = '';
              el.parentName.value = '';
              el.email.value = '';
              el.phone.value = '';
              el.smsConsent.checked = false;
              el.classroom.value = '';
              el.grade.value = '';
              el.duplicatePanel.style.display = 'none';
              clearErrors();
            } else {
              const err = await resp2.json();
              showErrors([err.message || 'Unknown error']);
            }
          } catch (e) {
            showErrors(['Network error.']);
            console.error(e);
          }
        });
        el.duplicatePanel.appendChild(overrideBtn);
      } else {
        const err = await resp.json();
        showErrors([err.message || 'Unknown error from server']);
      }
    } catch (e) {
      showErrors(['Network or server error.']);
      console.error(e);
    }
  });
})();
</script>
</body>
</html>