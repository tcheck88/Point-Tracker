name: Backup to Google Drive

on:
  schedule:
    # Runs every 15 minutes from 6am to 6pm PST (14:00 - 02:00 UTC)
    - cron: '*/15 14-23,0-2 * * *'
  workflow_dispatch: # Manual trigger

jobs:
  backup-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Install Postgres Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      # --- NEW: Install Rclone Officially ---
      - name: Install & Configure Rclone
        run: |
          # 1. Download and install the official Rclone binary
          sudo -v ; curl https://rclone.org/install.sh | sudo bash
          
          # 2. Create the configuration folder
          mkdir -p ~/.config/rclone
          
          # 3. Create the config file using your Secret
          # We use double quotes to preserve newlines in the secret
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      - name: Create Backups
        env:
          DEV_DB: ${{ secrets.SUPABASE_DEV_DB_URL }}
          PROD_DB: ${{ secrets.SUPABASE_PROD_DB_URL }}
        run: |
          mkdir -p backups
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M)
          
          echo "Backing up Dev..."
          pg_dump "$DEV_DB" --clean --if-exists --no-owner --file=backups/dev_$TIMESTAMP.sql
          
          echo "Backing up Prod..."
          pg_dump "$PROD_DB" --clean --if-exists --no-owner --file=backups/prod_$TIMESTAMP.sql

      - name: Upload to Google Drive
        run: |
          # The remote name 'gdrive' must match the [header] in your secret
          rclone copy backups/ gdrive:PointTracker_Backups
          
          echo "âœ… Backup Success!"
