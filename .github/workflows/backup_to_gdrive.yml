name: Backup to Google Drive

on:
  schedule:
    # Runs every 15 minutes from 6am to 6pm PST (14:00 UTC to 02:00 UTC)
    - cron: '*/15 14-23,0-2 * * *'
  workflow_dispatch: # Allows you to click "Run workflow" manually

jobs:
  backup-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Install Postgres Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Setup Rclone
        uses: animito/setup-rclone@v1
        with:
          rclone_config: ${{ secrets.RCLONE_CONFIG }}

      - name: Create Backups
        env:
          DEV_DB: ${{ secrets.SUPABASE_DEV_DB_URL }}
          PROD_DB: ${{ secrets.SUPABASE_PROD_DB_URL }}
        run: |
          mkdir backups
          # Create a timestamped filename (e.g., dev_2026-01-30_15-45.sql)
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M)
          
          echo "Backing up Dev..."
          pg_dump "$DEV_DB" --clean --if-exists --no-owner --file=backups/dev_$TIMESTAMP.sql
          
          echo "Backing up Prod..."
          pg_dump "$PROD_DB" --clean --if-exists --no-owner --file=backups/prod_$TIMESTAMP.sql

      - name: Upload to Google Drive
        run: |
          # Copy the 'backups' folder to a folder named 'PointTracker_Backups' in GDrive
          rclone copy backups/ gdrive:PointTracker_Backups
          
          echo "âœ… Backup Success!"
