{% extends "base.html" %}
{% block title %}{{ _('Redemption Report') }}{% endblock %}

{% block extra_css %}
<style>
    /* Match styles from Student Profile for consistency */
    .filter-bar { 
        display: flex; align-items: center; gap: 12px; background: #f8fafc; 
        padding: 8px 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0;
    }
    .filter-bar input, .filter-bar select { 
        padding: 4px 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 12px; color: #334155;
    }
    
    .btn-export { 
        background: #1f6feb; color: white; padding: 8px 16px; border-radius: 6px; 
        text-decoration: none; font-weight: 600; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-export:hover { background: #165ecb; }

    .redemption-table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .redemption-table th { 
        text-align: left; padding: 12px; border-bottom: 2px solid #e2e8f0; 
        background: #f8fafc; color: #64748b; font-weight: 600; 
    }
    .redemption-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #1e293b; }
    
    /* Responsive adjustment for small screens */
    @media (max-width: 600px) {
        .filter-bar { flex-direction: column; align-items: stretch; }
    }
</style>
{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto; background: white; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <a href="{{ url_for('index') }}" style="color: #1f6feb; text-decoration: none; font-size: 13px;">&larr; {{ _('Back to Dashboard') }}</a>
            <h1 style="margin: 8px 0 0; color: #0f172a; font-size: 24px;">{{ _('Redemption Log') }}</h1>
        </div>
        <a href="/api/reports/redemptions/csv" class="btn-export">
            <span>ðŸ“¥</span> {{ _('Download CSV') }}
        </a>
    </div>

    <div class="filter-bar">
        <span style="font-size: 11px; font-weight: 700; color: #64748b;">{{ _('FILTER:') }}</span>
        <select id="quickRange" onchange="setQuickRange()">
            <option value="all">{{ _('All Time') }}</option>
            <option value="0">{{ _('Today') }}</option>
            <option value="7">{{ _('Last 7 Days') }}</option>
            <option value="30">{{ _('Last 30 Days') }}</option>
            <option value="90">{{ _('Last 90 Days') }}</option>
        </select>
        <input type="date" id="startDate" onchange="applyFilters()">
        <span style="color: #cbd5e1;">to</span>
        <input type="date" id="endDate" onchange="applyFilters()">
    </div>

    <table class="redemption-table">
        <thead>
            <tr>
                <th>{{ _('Date') }}</th>
                <th>{{ _('Student') }}</th>
                <th>{{ _('Classroom') }}</th>
                <th>{{ _('Prize') }}</th>
                <th style="text-align: right;">{{ _('Points') }}</th>
                <th>{{ _('Staff') }}</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>
</div>

<script>
    // Pass the Python 'rows' data to JavaScript safely
    const allRows = {{ rows | tojson }}; 
    const _ = (s) => s; // Simple placeholder for JS translations

    document.addEventListener('DOMContentLoaded', () => {
        // Render all data initially
        renderTable(allRows);
    });

    function setQuickRange() {
        const range = document.getElementById('quickRange').value;
        const startInput = document.getElementById('startDate');
        const endInput = document.getElementById('endDate');

        if (range === 'all') {
            startInput.value = '';
            endInput.value = '';
        } else {
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - parseInt(range));
            
            startInput.value = start.toISOString().split('T')[0];
            endInput.value = end.toISOString().split('T')[0];
        }
        applyFilters();
    }

    function applyFilters() {
        const startVal = document.getElementById('startDate').value;
        const endVal = document.getElementById('endDate').value;
        
        // Filter the rows based on the timestamp
        const filtered = allRows.filter(row => {
            if (!row.timestamp) return false;
            const rowDate = new Date(row.timestamp);
            
            // Start Date Check
            if (startVal) {
                // Treat start date as beginning of that day (00:00:00)
                const s = new Date(startVal);
                if (rowDate < s) return false;
            }
            
            // End Date Check
            if (endVal) {
                // Treat end date as end of that day (23:59:59)
                const e = new Date(endVal);
                e.setHours(23, 59, 59, 999);
                if (rowDate > e) return false;
            }
            
            return true;
        });

        renderTable(filtered);
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="padding: 40px; text-align: center; color: #94a3b8;">${_('No redemptions found for this period.')}</td></tr>`;
            return;
        }

        tbody.innerHTML = data.map(row => {
            // Clean up prize name (remove "Redemption: " prefix if present)
            const prizeName = row.activity_type.replace('Redemption: ', '');
            
            return `
            <tr>
                <td style="color: #64748b;">${new Date(row.timestamp).toLocaleDateString()}</td>
                <td style="font-weight: 600;">${row.full_name}</td>
                <td>
                    ${row.classroom || '-'} 
                    <span style="color: #94a3b8; font-size: 11px;">(${row.grade || '?'})</span>
                </td>
                <td>${prizeName}</td>
                <td style="text-align: right; color: #dc2626; font-weight: 700;">${row.points}</td>
                <td style="font-size: 12px; color: #64748b;">${row.recorded_by || 'system'}</td>
            </tr>
            `;
        }).join('');
    }
</script>
{% endblock %}