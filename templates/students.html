{% extends "base.html" %}
{% block title %}{{ _('Student Directory') }}{% endblock %}

{% block extra_css %}
<style>
    /* Exact styles from your uploaded file */
    .wrap { max-width: 850px; margin: 0 auto; padding: 15px; background: #fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
    h1 { margin: 0 0 8px 0; font-size: 20px; color: #0b3b61; }
    .secondary-link { color: #1f6feb; text-decoration: none; font-size: 12px; display: inline-block; margin-bottom: 10px; }
    
    .search-container { background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #f3f4f6; margin-bottom: 15px; }
    .search-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input[type="text"] { flex: 1; min-width: 200px; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
    
    .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: background 0.2s; height: 36px; white-space: nowrap; }
    .btn-primary { background: #1f6feb; color: #fff; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } 
    .btn-info { background: #0ea5e9; color: #fff; } /* Added for Show All */
    
    .btn-primary:hover { background: #165ecb; }
    .btn-info:hover { background: #0284c7; }
    .btn-success:hover { background: #bbf7d0; }

    .filter-bar { margin: 12px 0; display: flex; gap: 15px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    
    #studentList { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 8px; }
    
    .student-card { border: 1px solid #e5e7eb; padding: 10px 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; background: #fff; text-decoration: none; color: inherit; transition: all 0.2s; }
    .student-card:hover { border-color: #1f6feb; background: #f0f9ff; transform: translateY(-1px); }
    
    .student-info h4 { margin: 0; font-size: 14px; color: #111827; }
    .student-info p { margin: 2px 0 0 0; font-size: 12px; color: #6b7280; }
    
    .points-badge { background: #e0f2fe; color: #0369a1; font-weight: bold; padding: 2px 8px; border-radius: 12px; font-size: 12px; min-width: 45px; text-align: center; }

    .status-message { margin-top: 10px; padding: 8px; border-radius: 4px; display: none; font-size: 13px; text-align: center; }
    .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    @media (max-width: 600px) { #studentList { grid-template-columns: 1fr; } }
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <a href="{{ url_for('index') }}" class="secondary-link">&larr; {{ _('Back to Dashboard') }}</a>
  <h1>{{ _('Student Directory') }}</h1>

  <div class="search-container">
    <form id="searchForm" class="search-row">
      <input type="text" id="searchInput" placeholder="{{ _('Search by name, nickname, or ID...') }}">
      <button type="submit" class="btn btn-primary">{{ _('Search') }}</button>
      
      <button type="button" class="btn btn-info" onclick="performShowAll()">{{ _('Show All') }}</button>
      
      <button type="button" class="btn btn-secondary" onclick="clearSearch()">{{ _('Reset') }}</button>
      
      <a href="{{ url_for('download_all_students_csv') }}" class="btn btn-success" style="text-decoration:none; display:flex; align-items:center;">
        ðŸ“¥ {{ _('Export CSV ') }}
      </a>
    </form>
  </div>

  <div class="filter-bar">
      <h2 style="margin:0; font-size: 16px; color: #0b3b61;">{{ _('Search Results') }}</h2>
      <div style="display: flex; gap: 15px;">
          <label style="font-size: 12px; font-weight: normal; display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="hideInactive" checked onchange="refreshCurrentView()"> {{ _('Hide Inactive') }}
          </label>
          <label style="font-size: 12px; font-weight: normal; display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="hideZeroPoints" onchange="renderStudentList()"> {{ _('Hide zero points') }}
          </label>
      </div>
  </div>

  <div id="statusMessage" class="status-message"></div>
  <div id="studentList"></div>
</div>

<script>
let currentStudents = [];
let isShowingAll = false; // Track state
const _ = (s) => s;

window.addEventListener('DOMContentLoaded', () => {
    const savedTerm = sessionStorage.getItem('studentSearchTerm');
    const savedHideZero = sessionStorage.getItem('studentHideZero');
    const savedHideInactive = sessionStorage.getItem('studentHideInactive');

    if (savedHideZero === 'true') {
        document.getElementById('hideZeroPoints').checked = true;
    }
    
    if (savedHideInactive !== null) {
        document.getElementById('hideInactive').checked = (savedHideInactive === 'true');
    }

    if (savedTerm) {
        document.getElementById('searchInput').value = savedTerm;
        performSearch(); 
    }
});

function refreshCurrentView() {
    if (isShowingAll) {
        performShowAll();
    } else {
        performSearch();
    }
}

// NEW FUNCTION: Triggered by the button
async function performShowAll() {
    document.getElementById('searchInput').value = '';
    sessionStorage.removeItem('studentSearchTerm');
    isShowingAll = true;
    
    await executeFetch({ showAll: true });
}

async function performSearch(e) {
    if (e) e.preventDefault();
    const term = document.getElementById('searchInput').value.trim();
    
    if (!term) return; 

    sessionStorage.setItem('studentSearchTerm', term);
    isShowingAll = false;

    await executeFetch({ term: term });
}

// Unified Fetcher
async function executeFetch(params) {
    const list = document.getElementById('studentList');
    const sm = document.getElementById('statusMessage');
    const hideInactive = document.getElementById('hideInactive').checked;
    
    sm.style.display = 'none';
    list.innerHTML = `<p style="grid-column: 1/-1; text-align:center; font-size:13px; padding: 20px;">${_('Loading...')}</p>`;

    try {
        const includeInactive = !hideInactive;
        let url = `/api/students/search?include_inactive=${includeInactive}`;
        
        if (params.showAll) {
            url += `&show_all=true`;
        } else if (params.term) {
            url += `&term=${encodeURIComponent(params.term)}`;
        }

        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success) {
            currentStudents = data.students || [];
            renderStudentList();
        } else {
            showError(data.message);
        }
    } catch (err) {
        showError(_("Error connecting to server."));
    }
}

function renderStudentList() {
    const list = document.getElementById('studentList');
    const hideZero = document.getElementById('hideZeroPoints').checked;
    
    sessionStorage.setItem('studentHideZero', hideZero);
    // NEW: Also save inactive state so page refreshes persist
    sessionStorage.setItem('studentHideInactive', document.getElementById('hideInactive').checked);

    list.innerHTML = '';
    
    const filtered = currentStudents.filter(s => {
        // Handle data whether it comes as Dict or Tuple (Safety net)
        const points = (s.total_points !== undefined) ? s.total_points : (s[5] || 0);
        if (hideZero && points <= 0) return false;
        return true;
    });

    if (filtered.length === 0) {
        list.innerHTML = `<p style="grid-column: 1/-1; text-align:center; color:#666; font-size:13px; padding: 20px;">${_('No matching students found.')}</p>`;
        return;
    }

    filtered.forEach(s => {
        // Normalize Data (Dict vs Tuple)
        const isDict = (s.id !== undefined);
        const id = isDict ? s.id : s[0];
        const name = isDict ? s.full_name : s[1];
        const classroom = isDict ? s.classroom : s[3];
        const grade = isDict ? s.grade : s[4];
        const points = isDict ? s.total_points : s[5];
        const active = isDict ? s.active : s[8];

        const card = document.createElement('a');
        card.className = 'student-card';
        card.href = `/student/${id}`;
        
        const inactiveStyle = (!active) ? 'opacity: 0.6; background: #fdf2f2;' : '';
        const nameSuffix = (!active) ? ' <span style="font-size:10px; color:#c53030; font-weight:bold;">(INACTIVE)</span>' : '';
        
        card.style = inactiveStyle;
        
        card.innerHTML = `
            <div class="student-info">
                <h4>${name}${nameSuffix} <small style="color:#666; font-weight:normal;">(#${id})</small></h4>
                <p>${classroom || 'N/A'} | ${grade || ''}</p>
            </div>
            <div class="points-badge">
                ${points || 0} pts
            </div>
        `;
        list.appendChild(card);
    });
}

function showError(msg) {
    const sm = document.getElementById('statusMessage');
    sm.textContent = msg;
    sm.className = 'status-message error';
    sm.style.display = 'block';
    document.getElementById('studentList').innerHTML = '';
}

function clearSearch() {
    sessionStorage.removeItem('studentSearchTerm');
    document.getElementById('searchInput').value = '';
    document.getElementById('studentList').innerHTML = '';
    document.getElementById('statusMessage').style.display = 'none';
    currentStudents = [];
    isShowingAll = false;
}

document.getElementById('searchForm').addEventListener('submit', performSearch);
</script>
{% endblock %}