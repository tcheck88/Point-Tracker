{% extends "base.html" %}
{% block title %}{{ _('Redeem Prizes') }}{% endblock %}

{% block extra_css %}
<style>
  /* Match spacing from Record Activity */
  .redeem-container { max-width: 1100px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
  
  .nav-bar { margin-bottom: 10px; }
  
  /* Consistent Back Button */
  .back-btn { 
      background: white; border: 1px solid var(--border); padding: 8px 14px; 
      border-radius: 6px; color: #64748b; font-size: 13px; cursor: pointer; 
      display: inline-flex; align-items: center; font-weight: 600; text-decoration: none;
  }
  .back-btn:hover { background: #f1f5f9; color: #0f172a; }

  /* Grid Layout matching the other page */
  .top-row { display: grid; grid-template-columns: 1fr 1fr; gap: 28px; }
  
  /* Standard Card Style */
  .card { 
      background: white; 
      border-radius: 12px; 
      border: 1px solid var(--border); 
      padding: 24px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
      display: flex; flex-direction: column;
  }
  
  /* Standard Header Style */
  h3 { 
      margin: 0 0 16px 0; 
      font-size: 16px; 
      color: #0f172a; 
      border-bottom: 1px solid #f1f5f9; 
      padding-bottom: 10px; 
      font-weight: 700;
  }

  /* Student Banner */
  #selectedDisplay { 
      display: none; justify-content: space-between; align-items: center; 
      background: #eff6ff; padding: 12px 16px; border-radius: 8px; 
      border: 1px solid #dbeafe; margin-top: 10px; 
  }

  /* Standard Input Style */
  input[type="text"] { 
      width: 100%; padding: 10px; border: 1px solid var(--border); 
      border-radius: 8px; font-size: 14px; 
  }

  /* History Table */
  .history-scroll { height: 140px; overflow-y: auto; border: 1px solid #f1f5f9; border-radius: 8px; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; padding: 10px 12px; background: #f8fafc; color: #64748b; font-weight: 600; position: sticky; top: 0; border-bottom: 1px solid var(--border); }
  td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; color: #334155; }

  /* Prize List */
  .prize-controls { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
  .prize-list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  
  .prize-row { 
      display: flex; align-items: center; justify-content: space-between; 
      padding: 10px 16px; background: #fff; border: 1px solid var(--border); 
      border-radius: 8px; cursor: pointer; transition: 0.1s; 
  }
  .prize-row:hover:not(.disabled) { border-color: var(--primary); background: #f0f7ff; }
  .prize-details { font-size: 14px; font-weight: 600; color: #1e293b; }
  .prize-meta { color: #64748b; font-size: 12px; margin-left: 8px; font-weight: normal; }
  .prize-row.disabled { opacity: 0.6; filter: grayscale(1); cursor: not-allowed; background: #f8fafc; }

  .btn-redeem { 
      background: var(--primary); color: #fff; border: none; border-radius: 6px; 
      padding: 6px 12px; font-size: 12px; font-weight: 600; cursor: pointer; 
  }
  .btn-redeem:disabled { background: #cbd5e1; cursor: not-allowed; }
  
  /* Loading Spinner Helper */
  .loading-box { text-align: center; padding: 15px; color: #64748b; font-size: 13px; }
</style>
{% endblock %}

{% block content %}
<div class="redeem-container">
    
    <div class="nav-bar">
        <button class="back-btn" onclick="window.history.back()">‚Üê {{ _('Back') }}</button>
    </div>

    <div class="top-row">
        <div class="card">
            <h3>{{ _('Identify Student') }}</h3>
            <div style="position: relative;">
                <input type="text" id="studentSearch" placeholder="{{ _('Search Name or ID...') }}" autocomplete="off">
                <div id="studentResults" style="position:absolute; width:100%; background:#fff; border:1px solid var(--border); border-radius:8px; z-index:100; max-height:200px; overflow-y:auto; display:none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 4px;"></div>
            </div>
            
            <div id="selectedDisplay">
                <span id="dispName" style="font-weight:700; font-size:15px; color:#1e293b;"></span>
                <div style="display:flex; align-items:baseline; gap:4px;">
                    <span id="dispPoints" style="font-weight:800; color:var(--primary); font-size:18px;">0</span>
                    <small style="font-size:11px; font-weight:700; color:var(--primary);">PTS</small>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>{{ _('Recent History') }}</h3>
            <div class="history-scroll">
                <table>
                    <thead>
                        <tr><th>{{ _('Date') }}</th><th>{{ _('Activity') }}</th><th style="text-align:right;">{{ _('Pts') }}</th></tr>
                    </thead>
                    <tbody id="historyBody">
                        <tr><td colspan="3" style="text-align:center; color:#94a3b8; padding:20px;">{{ _('Select a student') }}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="prize-controls">
            <h3 style="margin:0; border:none; padding:0; margin-right:auto;">{{ _('Redeemable Prizes') }}</h3>
            
            <input type="text" id="prizeSearch" placeholder="{{ _('Filter by prize name...') }}" oninput="renderPrizes()" style="width: 250px;">
            
            <label style="font-size:13px; font-weight:600; cursor:pointer; color:#64748b; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="filterPoints" checked onchange="renderPrizes()"> {{ _('Hide unaffordable') }}
            </label>
        </div>
        
        <div id="prizeContainer" class="prize-list-grid"></div>
    </div>
</div>

<script>
  let selectedId = null;
  let currentBalance = 0;
  let allPrizes = [];

  document.addEventListener('DOMContentLoaded', () => {
    fetchPrizes();
    
    // Check URL for student_id
    const urlParams = new URLSearchParams(window.location.search);
    const paramId = urlParams.get('student_id');
    if (paramId) {
        selectStudent(paramId);
    }
  });

  document.getElementById('studentSearch').oninput = async (e) => {
    const term = e.target.value.trim();
    const results = document.getElementById('studentResults');
    if (term.length < 2) { results.style.display = 'none'; return; }
    
    // 1. Show Searching Spinner
    results.style.display = 'block';
    results.innerHTML = `<div class="loading-box"><i class="fas fa-circle-notch fa-spin"></i> {{ _('Searching...') }}</div>`;
    
    const res = await fetch(`/api/students/search?term=${encodeURIComponent(term)}`);
    const data = await res.json();
    
    if (data.success) {
      if (data.students.length === 0) {
          results.innerHTML = `<div class="loading-box">{{ _('No students found.') }}</div>`;
      } else {
          results.innerHTML = data.students.map(s => `
            <div onclick="selectStudent(${s.id}, '${s.full_name.replace(/'/g, "\\'")}')" style="padding:10px; cursor:pointer; border-bottom:1px solid #f1f5f9; font-size:13px; color:#334155;">
              <strong>${s.full_name}</strong> <span style="color:#64748b;">(${s.total_points} pts)</span>
            </div>`).join('');
      }
    }
  };

  async function selectStudent(id, name = null) {
    selectedId = id;
    document.getElementById('studentResults').style.display = 'none';
    document.getElementById('studentSearch').value = '';
    
    // 2. Show Loading in History
    document.getElementById('historyBody').innerHTML = `<tr><td colspan="3" class="loading-box"><i class="fas fa-circle-notch fa-spin"></i> {{ _('Loading history...') }}</td></tr>`;
    
    // Fetch History & Balance
    const res = await fetch(`/api/student/${id}/history`);
    const data = await res.json();
    
    if (data.success) {
      currentBalance = data.total_points;
      
      const finalName = name || data.student_name || 'Student';
      
      document.getElementById('dispName').textContent = finalName;
      document.getElementById('dispPoints').textContent = currentBalance;
      document.getElementById('selectedDisplay').style.display = 'flex';
      
      if (data.history.length === 0) {
          document.getElementById('historyBody').innerHTML = `<tr><td colspan="3" style="text-align:center; padding:15px; color:#94a3b8;">{{ _('No recent history.') }}</td></tr>`;
      } else {
          document.getElementById('historyBody').innerHTML = data.history.slice(0, 10).map(h => `
            <tr>
              <td>${new Date(h.timestamp).toLocaleDateString()}</td>
              <td>${h.activity_type}</td>
              <td style="text-align:right; font-weight:700; color:${h.points < 0 ? '#dc2626' : '#059669'}">${h.points}</td>
            </tr>`).join('');
      }
      renderPrizes();
    }
  }

  async function fetchPrizes() {
    // Optional: Add loading state to prize container if it's slow
    const container = document.getElementById('prizeContainer');
    container.innerHTML = `<div style="grid-column:1/-1;" class="loading-box"><i class="fas fa-circle-notch fa-spin"></i> {{ _('Loading prizes...') }}</div>`;

    const res = await fetch('/api/prizes');
    const data = await res.json();
    allPrizes = data.prizes || [];
    renderPrizes();
  }

  function renderPrizes() {
    const container = document.getElementById('prizeContainer');
    const hideUnaffordable = document.getElementById('filterPoints').checked;
    const searchTerm = document.getElementById('prizeSearch').value.toLowerCase();
    container.innerHTML = '';
    
    if (allPrizes.length === 0) {
        container.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:#94a3b8;">{{ _('No prizes available.') }}</p>`;
        return;
    }

    allPrizes.forEach(p => {
      if (!p.active) return;
      const matchesSearch = p.name.toLowerCase().includes(searchTerm);
      const canAfford = currentBalance >= p.point_cost && p.stock_count > 0;
      
      if (!matchesSearch || (hideUnaffordable && !canAfford)) return;
      
      const div = document.createElement('div');
      div.className = `prize-row ${!canAfford ? 'disabled' : ''}`;
      const titleAttr = !canAfford ? 'title="{{ _("Not enough points or out of stock") }}"' : '';
      
      div.onclick = () => { if(canAfford && selectedId) redeemPrize(p.id, p.name); };
      div.innerHTML = `
        <div class="prize-details" ${titleAttr}>
          ${p.name} <span class="prize-meta">${p.point_cost} pts | Stock: ${p.stock_count}</span>
        </div>
        <button class="btn-redeem" ${(!canAfford || !selectedId) ? 'disabled' : ''}>{{ _('Redeem') }}</button>`;
      container.appendChild(div);
    });
  }

  async function redeemPrize(prizeId, name) {
    if (!confirm(`{{ _('Confirm redemption of') }} "${name}"?`)) return;
    
    // 3. UI Feedback during transaction
    document.body.style.cursor = 'wait';
    
    // DISABLE ALL BUTTONS
    document.querySelectorAll('.btn-redeem').forEach(b => b.disabled = true);
    
    try {
        const res = await fetch('/api/prizes/redeem', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ student_id: selectedId, prize_id: prizeId })
        });
        
        const result = await res.json();
        if (result.success) {
          // Await this so the UI stays locked until the refresh completes
          await selectStudent(selectedId, document.getElementById('dispName').textContent);
        } else {
          alert("Error: " + result.message);
          // Re-enable if we didn't call selectStudent
          renderPrizes();
        }
    } catch (e) {
        alert("Network Error");
        renderPrizes(); // Re-enable on crash
    } finally {
        document.body.style.cursor = 'default';
    }
  }
</script>
{% endblock %}