{% extends "base.html" %}
{% block title %}{{ _('Redeem Prizes') }}{% endblock %}

{% block extra_css %}
<style>
  /* Container Tightening */
  .container { padding: 5px 20px !important; }
  .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .btn-nav { background: var(--primary); color: #fff; border: none; border-radius: 6px; padding: 4px 10px; font-size: 12px; font-weight: 600; cursor: pointer; }

  /* Justified Two-Column Top Row */
  .top-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; display: flex; flex-direction: column; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  .section-title { margin: 0 0 6px 0; font-size: 11px; text-transform: uppercase; color: var(--secondary); font-weight: 700; }

  /* Student Horizontal Banner */
  #selectedDisplay { display: none; justify-content: space-between; align-items: center; background: #eff6ff; padding: 6px 10px; border-radius: 6px; border: 1px solid #dbeafe; margin-top: 6px; }

  /* History Table with Date */
  .history-scroll { height: 95px; overflow-y: auto; font-size: 11px; border: 1px solid #f1f5f9; border-radius: 6px; }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; padding: 4px 8px; background: #f8fafc; color: var(--secondary); font-size: 10px; position: sticky; top: 0; }
  td { padding: 4px 8px; border-bottom: 1px solid #f1f5f9; }

  /* Prize Controls & Single-Line Grid */
  .prize-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
  .prize-search { flex: 1; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; }
  .prize-list-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .prize-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 12px; background: #fff; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: 0.1s; }
  .prize-row:hover:not(.disabled) { border-color: var(--primary); background: #f0f7ff; }
  .prize-details { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
  .prize-meta { color: var(--secondary); font-size: 11px; margin-left: 8px; font-weight: normal; }
  .prize-row.disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
</style>
{% endblock %}

{% block content %}
<div class="nav-bar">
  <button class="btn-nav" onclick="window.history.back()">&larr; {{ _('Back') }}</button>
  <button class="btn-nav" onclick="location.href='{{ url_for('index') }}'">{{ _('Home') }}</button>
</div>

<div class="top-row">
  <div class="card">
    <h3 class="section-title">{{ _('Identify Student') }}</h3>
    <div style="position: relative;">
      <input type="text" id="studentSearch" style="width:100%; padding:7px; border-radius:6px; border:1px solid var(--border); font-size:13px;" placeholder="{{ _('Search Name or ID...') }}" autocomplete="off">
      <div id="studentResults" style="position:absolute; width:100%; background:#fff; border:1px solid var(--border); border-radius:6px; z-index:100; max-height:110px; overflow-y:auto; display:none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
    </div>
    <div id="selectedDisplay">
      <span id="dispName" style="font-weight:700; font-size:13px;"></span>
      <div style="display:flex; align-items:baseline; gap:3px;">
        <span id="dispPoints" style="font-weight:800; color:var(--primary); font-size:16px;">0</span>
        <small style="font-size:9px; font-weight:700;">PTS</small>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 class="section-title">{{ _('Recent History') }}</h3>
    <div class="history-scroll">
      <table>
        <thead>
          <tr><th>{{ _('Date') }}</th><th>{{ _('Activity') }}</th><th style="text-align:right;">{{ _('Pts') }}</th></tr>
        </thead>
        <tbody id="historyBody">
          <tr><td colspan="3" style="text-align:center; color:#94a3b8; padding:20px;">{{ _('Select a student') }}</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="card">
  <div class="prize-controls">
    <h3 class="section-title" style="margin:0;">{{ _('Redeemable Prizes') }}</h3>
    <input type="text" id="prizeSearch" class="prize-search" placeholder="{{ _('Filter by prize name...') }}" oninput="renderPrizes()">
    <label style="font-size:11px; font-weight:600; cursor:pointer; color:var(--secondary);">
      <input type="checkbox" id="filterPoints" checked onchange="renderPrizes()"> {{ _('Hide unaffordable') }}
    </label>
  </div>
  <div id="prizeContainer" class="prize-list-grid"></div>
</div>

<script>
  let selectedId = null;
  let currentBalance = 0;
  let allPrizes = [];

  document.addEventListener('DOMContentLoaded', () => {
    fetchPrizes();
    
    // NEW: Check URL for student_id
    const urlParams = new URLSearchParams(window.location.search);
    const paramId = urlParams.get('student_id');
    if (paramId) {
        // If ID exists, select student (name will be fetched automatically)
        selectStudent(paramId);
    }
  });

  document.getElementById('studentSearch').oninput = async (e) => {
    const term = e.target.value.trim();
    const results = document.getElementById('studentResults');
    if (term.length < 2) { results.style.display = 'none'; return; }
    const res = await fetch(`/api/students/search?term=${encodeURIComponent(term)}`);
    const data = await res.json();
    if (data.success) {
      results.innerHTML = data.students.map(s => `
        <div onclick="selectStudent(${s.id}, '${s.full_name.replace(/'/g, "\\'")}')" style="padding:7px; cursor:pointer; border-bottom:1px solid #f1f5f9; font-size:12px;">
          <strong>${s.full_name}</strong> <small>(${s.total_points} pts)</small>
        </div>`).join('');
      results.style.display = 'block';
    }
  };

  async function selectStudent(id, name = null) {
    selectedId = id;
    document.getElementById('studentResults').style.display = 'none';
    document.getElementById('studentSearch').value = '';
    
    // Fetch History & Balance
    const res = await fetch(`/api/student/${id}/history`);
    const data = await res.json();
    
    if (data.success) {
      currentBalance = data.total_points;
      
      // Use provided name OR name from API (fixing the profile link issue)
      const finalName = name || data.student_name || 'Student';
      
      document.getElementById('dispName').textContent = finalName;
      document.getElementById('dispPoints').textContent = currentBalance;
      document.getElementById('selectedDisplay').style.display = 'flex';
      
      document.getElementById('historyBody').innerHTML = data.history.slice(0, 8).map(h => `
        <tr>
          <td>${new Date(h.timestamp).toLocaleDateString()}</td>
          <td>${h.activity_type}</td>
          <td style="text-align:right; font-weight:700; color:${h.points < 0 ? '#dc2626' : '#059669'}">${h.points}</td>
        </tr>`).join('');
        
      renderPrizes();
    }
  }

  async function fetchPrizes() {
    const res = await fetch('/api/prizes');
    const data = await res.json();
    allPrizes = data.prizes || [];
    renderPrizes();
  }

  function renderPrizes() {
    const container = document.getElementById('prizeContainer');
    const hideUnaffordable = document.getElementById('filterPoints').checked;
    const searchTerm = document.getElementById('prizeSearch').value.toLowerCase();
    container.innerHTML = '';
    
    allPrizes.forEach(p => {
      if (!p.active) return;
      const matchesSearch = p.name.toLowerCase().includes(searchTerm);
      const canAfford = currentBalance >= p.point_cost && p.stock_count > 0;
      
      if (!matchesSearch || (hideUnaffordable && !canAfford)) return;
      
      const div = document.createElement('div');
      div.className = `prize-row ${!canAfford ? 'disabled' : ''}`;
      // Add visual tooltip if disabled
      const titleAttr = !canAfford ? 'title="{{ _("Not enough points or out of stock") }}"' : '';
      
      div.onclick = () => { if(canAfford && selectedId) redeemPrize(p.id, p.name); };
      div.innerHTML = `
        <div class="prize-details" ${titleAttr}>
          <strong>${p.name}</strong> <span class="prize-meta">${p.point_cost} pts | Stock: ${p.stock_count}</span>
        </div>
        <button class="btn-nav" style="padding:2px 8px; font-size:10px;" ${(!canAfford || !selectedId) ? 'disabled' : ''}>{{ _('Redeem') }}</button>`;
      container.appendChild(div);
    });
  }

  async function redeemPrize(prizeId, name) {
    if (!confirm(`{{ _('Confirm redemption of') }} "${name}"?`)) return;
    const res = await fetch('/api/prizes/redeem', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ student_id: selectedId, prize_id: prizeId })
    });
    
    const result = await res.json();
    if (result.success) {
      // Refresh balance and history after successful redemption
      selectStudent(selectedId, document.getElementById('dispName').textContent);
    } else {
      alert("Error: " + result.message);
    }
  }
</script>
{% endblock %}